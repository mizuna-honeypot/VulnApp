{% extends "base.html" %}

{% block title %}ã‚²ã‚¹ãƒˆãƒ–ãƒƒã‚¯ - Stored XSS ãƒ‡ãƒ¢{% endblock %}

{% block content %}
<div class="vuln-demo">
    <h2>ğŸ“ ã‚²ã‚¹ãƒˆãƒ–ãƒƒã‚¯ (Stored XSS ã®ãƒ‡ãƒ¢)</h2>
    
    <div class="warning-box">
        <h3>âš ï¸ è„†å¼±æ€§: Stored XSS (A03:2021)</h3>
        <p>ã“ã®ã‚²ã‚¹ãƒˆãƒ–ãƒƒã‚¯ã¯æ„å›³çš„ã«Stored XSSï¼ˆæ ¼ç´å‹ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒ†ã‚£ãƒ³ã‚°ï¼‰ã®è„†å¼±æ€§ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚</p>
    </div>

    <div class="demo-section">
        <h3>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿</h3>
        <form method="POST" action="/guestbook" class="guestbook-form">
            <div class="form-group">
                <label for="name">åå‰:</label>
                <input type="text" id="name" name="name" placeholder="åŒ¿å" maxlength="50">
            </div>
            <div class="form-group">
                <label for="comment">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</label>
                <textarea id="comment" name="comment" rows="4" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." required></textarea>
            </div>
            <button type="submit" class="btn">æŠ•ç¨¿ã™ã‚‹</button>
        </form>
    </div>

    <div class="demo-section">
        <h3>ğŸ’¡ è©¦ã—ã¦ã¿ã‚‹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰</h3>
        <ul class="payload-list">
            <li><code>&lt;script&gt;alert('Stored XSS')&lt;/script&gt;</code> - åŸºæœ¬çš„ãªXSS</li>
            <li><code>&lt;img src=x onerror=alert('XSS')&gt;</code> - ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ä½¿ç”¨</li>
            <li><code>&lt;svg/onload=alert('XSS')&gt;</code> - SVGã‚¿ã‚°ã‚’ä½¿ç”¨</li>
            <li><code>&lt;iframe src="javascript:alert('XSS')"&gt;</code> - iframeã‚’ä½¿ç”¨</li>
        </ul>
    </div>

    {% if entries %}
    <div class="result-section">
        <h3>æŠ•ç¨¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸{% if total_count > 0 %} (å…¨{{ total_count }}ä»¶ä¸­ {{ entries|length }}ä»¶ã‚’è¡¨ç¤º){% endif %}</h3>
        
    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    {% if total_pages > 1 %}
    <div class="pagination-section">
        <div class="pagination-info">
            <p>å…¨{{ total_count }}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒšãƒ¼ã‚¸ {{ page }} / {{ total_pages }}ï¼‰</p>
        </div>
        <div class="pagination-controls">
            {% if page > 1 %}
            <a href="?page=1" class="btn btn-pagination">Â« æœ€åˆ</a>
            <a href="?page={{ page - 1 }}" class="btn btn-pagination">â€¹ å‰ã¸</a>
            {% endif %}
            
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                    <span class="btn btn-pagination btn-current">{{ p }}</span>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                    <a href="?page={{ p }}" class="btn btn-pagination">{{ p }}</a>
                {% elif p == 4 or p == total_pages - 3 %}
                    <span class="btn btn-pagination btn-ellipsis">...</span>
                {% endif %}
            {% endfor %}
            
            {% if page < total_pages %}
            <a href="?page={{ page + 1 }}" class="btn btn-pagination">æ¬¡ã¸ â€º</a>
            <a href="?page={{ total_pages }}" class="btn btn-pagination">æœ€å¾Œ Â»</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

        <div class="messages-container">
            {% for entry in entries %}
            <div class="message-card">
                <div class="message-header">
                    <strong>{{ entry.name }}</strong>
                    <span class="message-date">{{ entry.created_at }}</span>
                </div>
                <div class="message-body">
                    <!-- ğŸš¨ æ„å›³çš„ãªè„†å¼±æ€§: safeãƒ•ã‚£ãƒ«ã‚¿ã§XSSå¯èƒ½ -->
                    {{ entry.comment | safe }}
                    
                    <!-- å±æ€§å€¤ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ : Tenable WASã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒ™ãƒ¼ã‚¹ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ¤œå‡ºç”¨ -->
                    <a href="{{ entry.comment | safe }}" class="hidden-link">ãƒªãƒ³ã‚¯</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    {% if total_pages > 1 %}
    <div class="pagination-section">
        <div class="pagination-info">
            <p>å…¨{{ total_count }}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒšãƒ¼ã‚¸ {{ page }} / {{ total_pages }}ï¼‰</p>
        </div>
        <div class="pagination-controls">
            {% if page > 1 %}
            <a href="?page=1" class="btn btn-pagination">Â« æœ€åˆ</a>
            <a href="?page={{ page - 1 }}" class="btn btn-pagination">â€¹ å‰ã¸</a>
            {% endif %}
            
            {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                    <span class="btn btn-pagination btn-current">{{ p }}</span>
                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 2 and p <= page + 2) %}
                    <a href="?page={{ p }}" class="btn btn-pagination">{{ p }}</a>
                {% elif p == 4 or p == total_pages - 3 %}
                    <span class="btn btn-pagination btn-ellipsis">...</span>
                {% endif %}
            {% endfor %}
            
            {% if page < total_pages %}
            <a href="?page={{ page + 1 }}" class="btn btn-pagination">æ¬¡ã¸ â€º</a>
            <a href="?page={{ total_pages }}" class="btn btn-pagination">æœ€å¾Œ Â»</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="info-box">
        <p>ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¨¿è€…ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼</p>
    </div>
    {% endif %}

    <div class="demo-section">
        <h3>ğŸ“– æŠ€è¡“çš„ãªèª¬æ˜</h3>
        <div class="code-block">
            <h4>è„†å¼±ãªã‚³ãƒ¼ãƒ‰:</h4>
            <pre>&lt;div&gt;{% raw %}{{ entry.comment | safe }}{% endraw %}&lt;/div&gt;</pre>
            <p>Jinjaãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®<code>| safe</code>ãƒ•ã‚£ãƒ«ã‚¿ã¯ã€HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã€‚</p>
        </div>
        <div class="code-block">
            <h4>å®‰å…¨ãªã‚³ãƒ¼ãƒ‰:</h4>
            <pre>&lt;div&gt;{% raw %}{{ entry.comment }}{% endraw %}&lt;/div&gt;</pre>
            <p><code>| safe</code>ãƒ•ã‚£ãƒ«ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã§ã€è‡ªå‹•çš„ã«HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã¾ã™ã€‚</p>
        </div>
        <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’è¡¨ç¤ºã™ã‚‹éš›ã¯ã€å¿…ãšé©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¾ãŸã¯ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã‚’è¡Œã†ã“ã¨ã§ã€XSSã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚</p>
    </div>

    <!-- ç®¡ç†è€…ç”¨ï¼šã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
    <div class="admin-section">
        <form method="POST" action="/guestbook/clear" 
              onsubmit="return confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
            <button type="submit" class="btn btn-danger">
                ğŸ—‘ï¸ å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼ˆç®¡ç†è€…ç”¨ï¼‰
            </button>
        </form>
    </div>
</div>

<style>
.vuln-demo {
    max-width: 900px;
    margin: 0 auto;
}

.warning-box {
    background-color: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 5px;
    padding: 15px;
    margin: 20px 0;
}

.demo-section {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 20px;
    margin: 20px 0;
}

.guestbook-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.form-group label {
    font-weight: bold;
    color: #333;
}

.form-group input[type="text"],
.form-group textarea {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    font-family: inherit;
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.payload-list {
    list-style: none;
    padding: 0;
}

.payload-list li {
    background-color: #fff;
    border-left: 4px solid #007bff;
    padding: 10px;
    margin: 10px 0;
    font-family: monospace;
}

.payload-list code {
    background-color: #f4f4f4;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 14px;
}

.info-box {
    background-color: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 5px;
    padding: 15px;
    margin: 20px 0;
}

.result-section {
    margin: 20px 0;
}

.messages-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-top: 20px;
}

.message-card {
    background-color: #fff;
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    transition: box-shadow 0.3s;
}

.message-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.message-header strong {
    color: #333;
    font-size: 1.1em;
}

.message-date {
    color: #666;
    font-size: 0.9em;
}

.message-body {
    color: #555;
    line-height: 1.6;
    position: relative;
}

/* å±æ€§å€¤ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ãƒªãƒ³ã‚¯ã‚’éè¡¨ç¤ºã« */
.hidden-link {
    display: none;
    position: absolute;
    width: 0;
    height: 0;
    opacity: 0;
    pointer-events: none;
}

.code-block {
    background-color: #fff;
    border-left: 4px solid #28a745;
    padding: 15px;
    margin: 15px 0;
}

.code-block pre {
    background-color: #f4f4f4;
    padding: 10px;
    border-radius: 4px;
    overflow-x: auto;
    font-family: monospace;
    font-size: 14px;
    margin: 10px 0;
}

.code-block code {
    background-color: #f4f4f4;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: monospace;
}

.admin-section {
    margin: 20px 0;
    padding: 15px;
    background-color: #f8d7da;
    border: 2px solid #dc3545;
    border-radius: 5px;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
}

.btn-danger:hover {
    background-color: #c82333;
}

/* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
.pagination-section {
    margin: 20px 0;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 5px;
    text-align: center;
}

.pagination-info {
    margin-bottom: 15px;
}

.pagination-info p {
    color: #666;
    font-size: 0.95em;
    margin: 0;
}

.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 5px;
}

.btn-pagination {
    padding: 8px 12px;
    background-color: #fff;
    border: 1px solid #ddd;
    color: #333;
    text-decoration: none;
    border-radius: 4px;
    font-size: 14px;
    transition: all 0.3s;
    display: inline-block;
    min-width: 40px;
    text-align: center;
}

.btn-pagination:hover {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

.btn-current {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
    font-weight: bold;
    cursor: default;
}

.btn-current:hover {
    background-color: #007bff;
    color: white;
}

.btn-ellipsis {
    background-color: transparent;
    border: none;
    cursor: default;
    padding: 8px 4px;
}

.btn-ellipsis:hover {
    background-color: transparent;
    color: #333;
}

</style>
{% endblock %}
