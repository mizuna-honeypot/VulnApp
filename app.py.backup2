from flask import Flask, render_template, request, send_file
import sqlite3
import os

app = Flask(__name__)

# æœ«å°¾ã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’æŸ”è»Ÿã«æ‰±ã†
app.url_map.strict_slashes = False

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ„å›³çš„ã«è¨­å®šã—ãªã„ï¼ˆè„†å¼±æ€§5ï¼‰
# æœ¬æ¥ã¯ @app.after_request ã§è¨­å®šã™ã¹ã

def get_db_connection():
    """ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’å–å¾—"""
    conn = sqlite3.connect('vulnapp.db')
    conn.row_factory = sqlite3.Row
    return conn


@app.route('/')
def index():
    """ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸"""
    return render_template('index.html')


@app.route('/products')
def products():
    """å•†å“ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆæ¤œç´¢æ©Ÿèƒ½ä»˜ãï¼‰
    
    è„†å¼±æ€§1: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
    è„†å¼±æ€§2: XSS (Reflected)
    """
    search_query = request.args.get('search', '')
    
    conn = get_db_connection()
    
    if search_query:
        # ğŸš¨ è„†å¼±æ€§1: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
        # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç›´æ¥SQLæ–‡ã«åŸ‹ã‚è¾¼ã‚“ã§ã„ã‚‹
        query = f"SELECT * FROM products WHERE name LIKE '%{search_query}%' OR description LIKE '%{search_query}%'"
        products = conn.execute(query).fetchall()
    else:
        products = conn.execute('SELECT * FROM products').fetchall()
    
    conn.close()
    
    # ğŸš¨ è„†å¼±æ€§2: XSS (Reflected)
    # search_queryã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã›ãšã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã™
    return render_template('products.html', products=products, search_query=search_query)


@app.route('/product/<int:product_id>')
def product_detail(product_id):
    """å•†å“è©³ç´°ãƒšãƒ¼ã‚¸ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼‰
    
    è„†å¼±æ€§3: XSS (Stored) - ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚
    """
    conn = get_db_connection()
    
    product = conn.execute('SELECT * FROM products WHERE id = ?', (product_id,)).fetchone()
    
    if not product:
        return 'å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 404
    
    # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
    reviews = conn.execute(
        'SELECT * FROM reviews WHERE product_id = ? ORDER BY created_at DESC',
        (product_id,)
    ).fetchall()
    
    conn.close()
    
    # ğŸš¨ è„†å¼±æ€§3: XSS (Stored)
    # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã›ãšã«è¡¨ç¤º
    return render_template('product_detail.html', product=product, reviews=reviews)


@app.route('/product/<int:product_id>/review', methods=['POST'])
def add_review(product_id):
    """ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿
    
    è„†å¼±æ€§3: XSS (Stored) - ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿å­˜æ™‚
    """
    author = request.form.get('author', 'åŒ¿å')
    comment = request.form.get('comment', '')
    rating = request.form.get('rating', 5)
    
    if not comment:
        return 'ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 400
    
    conn = get_db_connection()
    
    # ğŸš¨ è„†å¼±æ€§3: XSS (Stored)
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã›ãšã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
    conn.execute(
        'INSERT INTO reviews (product_id, author, comment, rating) VALUES (?, ?, ?, ?)',
        (product_id, author, comment, int(rating))
    )
    conn.commit()
    conn.close()
    
    return f'''
    <html>
    <head><meta charset="UTF-8"></head>
    <body>
        <h2>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ</h2>
        <p><a href="/product/{product_id}">å•†å“ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a></p>
    </body>
    </html>
    '''


@app.route('/files')
def file_view():
    """ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤ºæ©Ÿèƒ½
    
    è„†å¼±æ€§4: ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«
    """
    filename = request.args.get('file', '')
    content = None
    error = None
    
    if filename:
        try:
            # ğŸš¨ è„†å¼±æ€§4: ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«
            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®æ¤œè¨¼ã‚’ã›ãšã«ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            file_path = os.path.join('static/files', filename)
            
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
        except Exception as e:
            error = f'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}'
    
    return render_template('file_view.html', filename=filename, content=content, error=error)


@app.route('/api/info')
def api_info():
    """APIæƒ…å ±ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®æ¼æ´©ä¾‹ï¼‰"""
    import sys
    import flask
    return {
        'version': '1.0.0',
        'python_version': sys.version,
        'debug': True,
        'database': 'vulnapp.db',
        'framework': 'Flask ' + flask.__version__,
        'werkzeug_version': flask.__version__
    }


if __name__ == '__main__':
    # ğŸš¨ è„†å¼±æ€§5: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ¬ å¦‚
    # debug=True ã¯æœ¬ç•ªç’°å¢ƒã§ã¯å±é™º
    app.run(host='0.0.0.0', port=5000, debug=True)
